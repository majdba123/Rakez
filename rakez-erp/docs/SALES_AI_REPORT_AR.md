# تقرير شامل: نظام إدارة المبيعات والمساعد الذكي

## الجزء الأول: نظام إدارة قسم المبيعات

### 1. لوحة التحكم (Dashboard)
توفر لوحة التحكم نظرة شاملة على أداء المبيعات، مع إمكانية التصفية حسب النطاق (شخصي أو فريق) والفترة الزمنية.

**مؤشرات الأداء (KPIs):**
- إجمالي المبيعات المحققة.
- عدد الحجوزات النشطة.
- نسبة الإنجاز مقارنة بالأهداف.

**مثال الكود (Service):**
```php
public function getKPIs(string $scope, ?string $from, ?string $to, User $user): array
{
    $query = SalesReservation::where('status', 'confirmed');
    if ($scope === 'me') {
        $query->where('marketing_employee_id', $user->id);
    }
    // ... logic for team filtering and date ranges
    return [
        'total_sales' => $query->sum('down_payment_amount'),
        'count' => $query->count(),
    ];
}
```

### 2. نظام الحجوزات (Reservations)
يعد نظام الحجوزات القلب النابض للمبيعات، حيث يضمن منع الحجز المزدوج من خلال تقنيات `DB Locking`.

**دورة حياة الحجز:**
1. **قيد التفاوض (Under Negotiation):** حجز مؤقت للوحدة.
2. **مؤكد (Confirmed):** بعد دفع العربون.
3. **ملغي (Cancelled):** في حال عدم إتمام الصفقة.

**منع الحجز المزدوج:**
يتم استخدام `lockForUpdate()` لضمان عدم حجز نفس الوحدة من قبل موظفين في نفس اللحظة.

```php
$unit = ContractUnit::where('id', $data['contract_unit_id'])
    ->lockForUpdate()
    ->first();
```

### 3. الأهداف والمهام (Targets & Tasks)
يستطيع قادة الفرق تعيين أهداف شهرية للمسوقين ومتابعة تقدمهم.

---

## الجزء الثاني: المساعد الذكي (AI Assistant)

### 1. نظرة عامة
المساعد الذكي هو نظام متطور يعتمد على GPT-4 لتوفير إجابات دقيقة بناءً على بيانات النظام الحقيقية.

### 2. إدارة السياق (Context Management)
يتم بناء السياق ديناميكياً بناءً على صلاحيات المستخدم والقسم المختار.

**أمثلة الأقسام:**
- **Units:** معلومات الوحدات المتاحة.
- **Contracts:** تفاصيل العقود والاتفاقيات.

### 3. نظام الميزانية (Budgeting)
يتم تتبع استهلاك الرموز (Tokens) يومياً لكل مستخدم لمنع تجاوز الميزانية المحددة.

```php
$used = AIConversation::where('user_id', $user->id)
    ->where('created_at', '>=', now()->startOfDay())
    ->sum('total_tokens');
```

---

## الجزء الثالث: أمثلة عملية

### سيناريو: حجز وحدة سكنية
1. يقوم الموظف بالاستعلام عن الوحدات المتاحة عبر المساعد الذكي.
2. يختار الوحدة ويقوم بإنشاء حجز "قيد التفاوض".
3. بعد استلام العربون، يتم تحويل الحالة إلى "مؤكد" وإصدار قسيمة الحجز (Voucher).
