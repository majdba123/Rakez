# Credit Frontend – Checklist لتجنب أخطاء شائعة

## 1. تحديث التفاوض: عدم إرسال `undefined` كمعرف الحجز

**الخطأ في الكونسول:**
```text
PUT /api/credit/bookings/negotiation/undefined → 404 (معرف الحجز غير صالح)
```

**السبب:** استدعاء `updateNegotiation` أو الطلب إلى `.../negotiation/{id}` بقيمة `id = undefined`.

**الحل (في مشروع الواجهة الأمامية):**

- قبل استدعاء تحديث التفاوض تأكد أن لديك **معرف حجز رقمي صالح** (مثلاً من الصف المحدد في قائمة التفاوض أو من تفاصيل الحجز).
- لا تستدعِ الطلب إذا كان الـ id غير معرّف، مثلاً:

```javascript
// في creditService أو عند استدعاء التحديث
if (bookingId == null || bookingId === undefined || bookingId === '') {
  // إما عدم استدعاء الـ API، أو عرض رسالة للمستخدم
  return;
}
await api.put(`/credit/bookings/negotiation/${bookingId}`, body);
```

- تأكد أن المكوّن الذي يفتح نافذة "تحديث التفاوض" (مثلاً `NegotiationUpdateModal`) يستقبل ويخزّن `bookingId` أو `reservation.id` من السياق (قائمة التفاوض أو تفاصيل الحجز) ويمرّره عند الإرسال وليس `undefined`.

---

## 2. WebSocket: فشل الاتصال بـ `ws://10.2.0.2:8080/ws`

**الخطأ في الكونسول:**
```text
WebSocket connection to 'ws://10.2.0.2:8080/ws' failed
```

**السبب:** تطبيق الواجهة الأمامية يحاول الاتصال بخادم WebSocket (مثلاً Laravel Reverb) على العنوان `10.2.0.2:8080`، إما أن الخادم غير شغال هناك أو الإعداد خاطئ.

**ما يجب التحقق منه:**

1. **تشغيل Reverb:** على السيرفر/الجهاز الذي تستخدمه (مثلاً نفس جهاز الـ API):
   ```bash
   php artisan reverb:start
   ```
   افتراضيًا Reverb يعمل على المنفذ `8080`.

2. **عنوان الويب سوكيت في الواجهة:** يجب أن يكون نفس العنوان والمنفذ الذي يعمل عليه Reverb:
   - تطوير محلي: غالباً `ws://127.0.0.1:8080` أو `ws://localhost:8080` (حسب إعدادك).
   - إذا كان الـ API على جهاز والواجهة على جهاز آخر، استخدم IP الجهاز الذي يشغّل Reverb والمنفذ الصحيح (مثلاً `8080`).

3. **متغيرات البيئة في الواجهة:** إذا كان عنوان الـ WebSocket يأتي من متغير (مثل `VITE_WS_HOST`, `VITE_WS_PORT`)، تأكد أن قيمها تطابق مكان تشغيل Reverb وليس عنواناً قديماً (مثل `10.2.0.2`) إن لم يعد صحيحاً.

4. **المراجع:** إعداد Reverb والواجهة موضح في:
   - `docs/WEBSOCKET_SETUP.md`
   - `docs/FRONTEND_WEBSOCKET_GUIDE.md`

---

## ملخص

| المشكلة | المكان الذي يُصلح فيه | الإجراء |
|--------|------------------------|---------|
| `negotiation/undefined` → 404 | مشروع الواجهة (Vue) | عدم استدعاء تحديث التفاوض إلا بمعرف حجز صالح، وتمرير هذا الـ id من القائمة/التفاصيل. |
| WebSocket connection failed | إعداد الواجهة + تشغيل Reverb | تشغيل Reverb على المنفذ الصحيح وتوجيه الواجهة إلى نفس الـ host والمنفذ (ومتغيرات البيئة إن وُجدت). |

الـ API في الـ Backend يتصرف كما هو متوقع: يرد 404 مع "معرف الحجز غير صالح" عندما يكون الـ id غير رقمي؛ إصلاح مصدر الـ `undefined` يكون من الواجهة الأمامية.
