# ุฏููู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ูููุทูุฑูู - ูุธุงู ุงูุนูููุงุช ูุงููุจูุนุงุช

## ๐ ุฌุฏูู ุงููุญุชููุงุช

1. [ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุธุงู](#ูุธุฑุฉ-ุนุงูุฉ-ุนูู-ุงููุธุงู)
2. [ุงููุตุงุฏูุฉ ูุงูุชูููุถ](#ุงููุตุงุฏูุฉ-ูุงูุชูููุถ)
3. [ูููู ุงูุงุณุชุฌุงุจุงุช](#ูููู-ุงูุงุณุชุฌุงุจุงุช)
4. [ุฑููุฒ ุงูุฃุฎุทุงุก](#ุฑููุฒ-ุงูุฃุฎุทุงุก)
5. [ููุงุท ุงูููุงูุฉ - ููุญุฉ ุงูุชุญูู](#ููุงุท-ุงูููุงูุฉ---ููุญุฉ-ุงูุชุญูู)
6. [ููุงุท ุงูููุงูุฉ - ุงูุนูููุงุช](#ููุงุท-ุงูููุงูุฉ---ุงูุนูููุงุช)
7. [ููุงุท ุงูููุงูุฉ - ุงููุฏุงุฆุน](#ููุงุท-ุงูููุงูุฉ---ุงููุฏุงุฆุน)
8. [ุฃูุซูุฉ ุงูุชูุงูู](#ุฃูุซูุฉ-ุงูุชูุงูู)
9. [ุฃูุถู ุงูููุงุฑุณุงุช](#ุฃูุถู-ุงูููุงุฑุณุงุช)
10. [ุญุงูุงุช ุงูุงุณุชุฎุฏุงู ุงูุดุงุฆุนุฉ](#ุญุงูุงุช-ุงูุงุณุชุฎุฏุงู-ุงูุดุงุฆุนุฉ)
11. [ุงุณุชูุดุงู ุงูุฃุฎุทุงุก ูุฅุตูุงุญูุง](#ุงุณุชูุดุงู-ุงูุฃุฎุทุงุก-ูุฅุตูุงุญูุง)

---

## ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุธุงู

### ูุง ูู ูุธุงู ุงูุนูููุงุช ูุงููุจูุนุงุชุ

ูุธุงู ุดุงูู ูุฅุฏุงุฑุฉ ุนูููุงุช ุงููุจูุนุงุช ุงูุนูุงุฑูุฉ ูุชูุฒูุนูุง ุนูู ูุฑูู ุงููุจูุนุงุชุ ุจุงูุฅุถุงูุฉ ุฅูู ุฅุฏุงุฑุฉ ุงููุฏุงุฆุน ูุงุณุชุฑุฏุงุฏูุง.

### ุงูููููุงุช ุงูุฑุฆูุณูุฉ

```mermaid
graph TD
    A[ูุธุงู ุงูุนูููุงุช ูุงููุจูุนุงุช] --> B[ููุญุฉ ุงูุชุญูู]
    A --> C[ุฅุฏุงุฑุฉ ุงูุนูููุงุช]
    A --> D[ุฅุฏุงุฑุฉ ุงููุฏุงุฆุน]
    
    B --> B1[ูุคุดุฑุงุช ุงูุฃุฏุงุก]
    B --> B2[ุงูุชูุงุฑูุฑ]
    
    C --> C1[ุฅูุดุงุก ุงูุนูููุฉ]
    C --> C2[ุชูุฒูุน ุงูุนูููุฉ]
    C --> C3[ุงุนุชูุงุฏ ุงูุนูููุฉ]
    C --> C4[ุตุฑู ุงูุนูููุฉ]
    
    D --> D1[ุฅูุดุงุก ุงููุฏูุนุฉ]
    D --> D2[ุชุฃููุฏ ุงูุงุณุชูุงู]
    D --> D3[ุงูุงุณุชุฑุฏุงุฏ]
```

### ุงูุฃุฏูุงุฑ ูุงูุตูุงุญูุงุช

| ุงูุฏูุฑ | ุงูุตูุงุญูุงุช |
|------|-----------|
| **Admin** | ุฌููุน ุงูุตูุงุญูุงุช |
| **Sales Manager** | ุฅูุดุงุก ูุชูุฒูุน ูุงุนุชูุงุฏ ุงูุนูููุงุชุ ุฅุฏุงุฑุฉ ุงููุฏุงุฆุน |
| **Accountant** | ุชุฃููุฏ ุงููุฏุงุฆุนุ ุตุฑู ุงูุนูููุงุช |
| **Sales** | ุนุฑุถ ุนูููุงุชู ุงูุฎุงุตุฉุ ุฅูุดุงุก ูุฏุงุฆุน |

---

## ุงููุตุงุฏูุฉ ูุงูุชูููุถ

### ุทุฑููุฉ ุงููุตุงุฏูุฉ

ูุณุชุฎุฏู ุงููุธุงู **Laravel Sanctum** ูููุตุงุฏูุฉ ุนุจุฑ API tokens.

### ุฅุนุฏุงุฏ ุงูู Headers

```javascript
const headers = {
  'Authorization': `Bearer ${token}`,
  'Content-Type': 'application/json',
  'Accept': 'application/json',
  'X-Requested-With': 'XMLHttpRequest'
};
```

### ูุซุงู ุนูู ุชุณุฌูู ุงูุฏุฎูู

```javascript
// ุชุณุฌูู ุงูุฏุฎูู
const login = async (email, password) => {
  const response = await axios.post('/api/login', {
    email,
    password
  });
  
  const token = response.data.data.token;
  
  // ุญูุธ ุงูู token
  localStorage.setItem('auth_token', token);
  
  return token;
};

// ุงุณุชุฎุฏุงู ุงูู token
axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
```

### ุงูุชุญูู ูู ุงูุตูุงุญูุงุช

```javascript
// ุงูุชุญูู ูู ุตูุงุญูุฉ ูุนููุฉ
const hasPermission = (user, permission) => {
  return user.permissions.includes(permission);
};

// ูุซุงู
if (hasPermission(currentUser, 'commissions.create')) {
  // ูููู ุฅูุดุงุก ุนูููุฉ
}
```

---

## ูููู ุงูุงุณุชุฌุงุจุงุช

### ุงุณุชุฌุงุจุฉ ูุงุฌุญุฉ

```json
{
  "success": true,
  "message": "ุชูุช ุงูุนูููุฉ ุจูุฌุงุญ",
  "data": {
    // ุงูุจูุงูุงุช ุงููุทููุจุฉ
  },
  "meta": {
    // ูุนูููุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)
  }
}
```

### ุงุณุชุฌุงุจุฉ ูุน Pagination

```json
{
  "success": true,
  "message": "ุชู ุฌูุจ ุงูุจูุงูุงุช ุจูุฌุงุญ",
  "data": [
    // ุนูุงุตุฑ ุงูุตูุญุฉ ุงูุญุงููุฉ
  ],
  "meta": {
    "pagination": {
      "total": 100,
      "count": 15,
      "per_page": 15,
      "current_page": 1,
      "total_pages": 7,
      "has_more_pages": true
    }
  }
}
```

### ุงุณุชุฌุงุจุฉ ุฎุทุฃ

```json
{
  "success": false,
  "message": "ุฑุณุงูุฉ ุงูุฎุทุฃ ุจุงูุนุฑุจูุฉ",
  "error_code": "COMM_001",
  "errors": {
    // ุชูุงุตูู ุงูุฃุฎุทุงุก (ูู ุญุงูุฉ validation)
  }
}
```

---

## ุฑููุฒ ุงูุฃุฎุทุงุก

ููุญุตูู ุนูู ูุงุฆูุฉ ูุงููุฉ ุจุฑููุฒ ุงูุฃุฎุทุงุกุ ุฑุงุฌุน [ูุฑุฌุน ุฑููุฒ ุงูุฃุฎุทุงุก](./ERROR_CODES_REFERENCE.md).

### ุงูุฑููุฒ ุงูุฃุณุงุณูุฉ

| HTTP Code | ุงููุนูู | ุงูุงุณุชุฎุฏุงู |
|-----------|--------|-----------|
| 200 | OK | ูุฌุงุญ ุงูุนูููุฉ |
| 201 | Created | ุชู ุงูุฅูุดุงุก ุจูุฌุงุญ |
| 400 | Bad Request | ุทูุจ ุบูุฑ ุตุญูุญ |
| 401 | Unauthorized | ุบูุฑ ูุตุฑุญ |
| 403 | Forbidden | ููููุน |
| 404 | Not Found | ุบูุฑ ููุฌูุฏ |
| 422 | Validation Error | ุฎุทุฃ ูู ุงูุชุญูู |
| 500 | Server Error | ุฎุทุฃ ูู ุงูุฎุงุฏู |

---

## ููุงุท ุงูููุงูุฉ - ููุญุฉ ุงูุชุญูู

### 1. ุงูุญุตูู ุนูู ูุคุดุฑุงุช ุงูุฃุฏุงุก (KPIs)

**Endpoint:** `GET /api/sales/dashboard`

**ุงููุตู:** ุฌูุจ ุฌููุน ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ ูููุญุฉ ุงูุชุญูู

**Parameters:**
```javascript
{
  date_from: '2026-01-01',  // ุงุฎุชูุงุฑู
  date_to: '2026-12-31',    // ุงุฎุชูุงุฑู
  project_id: 123           // ุงุฎุชูุงุฑู
}
```

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุฌูุจ ุงูุจูุงูุงุช ุจูุฌุงุญ",
  "data": {
    "units_sold": 45,
    "total_sales_value": 125000000,
    "total_received_deposits": 15000000,
    "total_refunded_deposits": 500000,
    "total_commissions": 3125000,
    "pending_commissions": 625000,
    "approved_commissions": 1875000,
    "paid_commissions": 625000
  }
}
```

**ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู:**
```javascript
const getDashboardKPIs = async (filters = {}) => {
  try {
    const response = await axios.get('/api/sales/dashboard', {
      params: filters
    });
    return response.data.data;
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฌูุจ ูุคุดุฑุงุช ุงูุฃุฏุงุก:', error);
    throw error;
  }
};

// ุงูุงุณุชุฎุฏุงู
const kpis = await getDashboardKPIs({
  date_from: '2026-01-01',
  date_to: '2026-01-31'
});
console.log(`ุงููุญุฏุงุช ุงููุจุงุนุฉ: ${kpis.units_sold}`);
```

---

### 2. ูุงุฆูุฉ ุงููุญุฏุงุช ุงููุจุงุนุฉ

**Endpoint:** `GET /api/sales/sold-units`

**ุงููุตู:** ุฌูุจ ูุงุฆูุฉ ููุตูุฉ ุจุงููุญุฏุงุช ุงููุจุงุนุฉ

**Parameters:**
```javascript
{
  date_from: '2026-01-01',
  date_to: '2026-12-31',
  project_id: 123,
  status: 'sold',
  per_page: 15,
  page: 1
}
```

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุฌูุจ ุงููุงุฆูุฉ ุจูุฌุงุญ",
  "data": [
    {
      "id": 1,
      "unit_number": "A-101",
      "project_name": "ูุดุฑูุน ุงููุฎูู",
      "selling_price": 1500000,
      "sale_date": "2026-01-15",
      "client_name": "ุฃุญูุฏ ูุญูุฏ",
      "sales_person": "ุฎุงูุฏ ุนูู",
      "commission_status": "approved"
    }
  ],
  "meta": {
    "pagination": {
      "total": 45,
      "current_page": 1,
      "per_page": 15,
      "total_pages": 3
    }
  }
}
```

---

### 3. ุฅุญุตุงุฆูุงุช ุงููุฏุงุฆุน ุญุณุจ ุงููุดุฑูุน

**Endpoint:** `GET /api/sales/deposits/stats/project/{contractId}`

**ุงููุตู:** ุฌูุจ ุฅุญุตุงุฆูุงุช ุงููุฏุงุฆุน ููุดุฑูุน ูุนูู

**Response:**
```json
{
  "success": true,
  "data": {
    "project_id": 123,
    "project_name": "ูุดุฑูุน ุงููุฎูู",
    "total_deposits": 25,
    "total_amount": 5000000,
    "received_amount": 4500000,
    "refunded_amount": 500000,
    "pending_count": 5,
    "received_count": 18,
    "refunded_count": 2
  }
}
```

---

### 4. ุฅุญุตุงุฆูุงุช ุงูุนูููุงุช ุญุณุจ ุงูููุธู

**Endpoint:** `GET /api/sales/commissions/stats/employee/{userId}`

**Parameters:**
```javascript
{
  date_from: '2026-01-01',
  date_to: '2026-12-31'
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "employee_id": 456,
    "employee_name": "ุฎุงูุฏ ุนูู",
    "total_commissions": 125000,
    "pending_amount": 25000,
    "approved_amount": 75000,
    "paid_amount": 25000,
    "distributions_count": 15,
    "breakdown_by_type": {
      "lead_generation": 37500,
      "persuasion": 31250,
      "closing": 37500,
      "management": 18750
    }
  }
}
```

---

### 5. ุชูุฑูุฑ ุงูุนูููุงุช ุงูุดูุฑู

**Endpoint:** `GET /api/sales/commissions/monthly-report`

**Parameters:**
```javascript
{
  year: 2026,
  month: 1  // 1-12
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "year": 2026,
    "month": 1,
    "month_name": "ููุงูุฑ",
    "total_commissions": 625000,
    "total_distributions": 45,
    "by_employee": [
      {
        "employee_id": 456,
        "employee_name": "ุฎุงูุฏ ุนูู",
        "total_amount": 125000,
        "distributions_count": 9
      }
    ],
    "by_type": {
      "lead_generation": 187500,
      "persuasion": 156250,
      "closing": 187500,
      "management": 93750
    }
  }
}
```

---

## ููุงุท ุงูููุงูุฉ - ุงูุนูููุงุช

### 1. ูุงุฆูุฉ ุงูุนูููุงุช

**Endpoint:** `GET /api/sales/commissions`

**ุงููุตู:** ุฌูุจ ูุงุฆูุฉ ุงูุนูููุงุช ูุน ุฅููุงููุฉ ุงูุชุตููุฉ

**Parameters:**
```javascript
{
  status: 'pending',  // pending, approved, paid
  project_id: 123,
  date_from: '2026-01-01',
  date_to: '2026-12-31',
  per_page: 15,
  page: 1
}
```

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุฌูุจ ูุงุฆูุฉ ุงูุนูููุงุช ุจูุฌุงุญ",
  "data": [
    {
      "id": 1,
      "contract_unit_id": 101,
      "sales_reservation_id": 201,
      "final_selling_price": 1500000,
      "commission_percentage": 2.5,
      "total_amount": 37500,
      "vat": 5625,
      "marketing_expenses": 2000,
      "bank_fees": 500,
      "net_amount": 29375,
      "commission_source": "owner",
      "status": "pending",
      "created_at": "2026-01-15T10:30:00Z",
      "contract_unit": {
        "id": 101,
        "unit_number": "A-101"
      },
      "sales_reservation": {
        "id": 201,
        "client_name": "ุฃุญูุฏ ูุญูุฏ"
      },
      "distributions": []
    }
  ],
  "meta": {
    "pagination": {
      "total": 25,
      "current_page": 1,
      "per_page": 15,
      "total_pages": 2
    }
  }
}
```

**ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู:**
```javascript
const getCommissions = async (filters = {}) => {
  try {
    const response = await axios.get('/api/sales/commissions', {
      params: filters
    });
    return response.data;
  } catch (error) {
    handleError(error);
  }
};

// ุงุณุชุฎุฏุงู ูุน ุชุตููุฉ
const pendingCommissions = await getCommissions({
  status: 'pending',
  per_page: 20
});
```

---

### 2. ุฅูุดุงุก ุนูููุฉ ุฌุฏูุฏุฉ

**Endpoint:** `POST /api/sales/commissions`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ:** `commissions.create`

**Request Body:**
```json
{
  "contract_unit_id": 101,
  "sales_reservation_id": 201,
  "final_selling_price": 1500000,
  "commission_percentage": 2.5,
  "commission_source": "owner",
  "team_responsible": "ูุฑูู ุงููุจูุนุงุช ุฃ"
}
```

**Validation Rules:**
```javascript
{
  contract_unit_id: 'required|exists:contract_units,id',
  sales_reservation_id: 'required|exists:sales_reservations,id',
  final_selling_price: 'required|numeric|min:1',
  commission_percentage: 'required|numeric|min:0|max:100',
  commission_source: 'required|in:owner,buyer',
  team_responsible: 'nullable|string|max:255'
}
```

**Response (201 Created):**
```json
{
  "success": true,
  "message": "ุชู ุฅูุดุงุก ุงูุนูููุฉ ุจูุฌุงุญ",
  "data": {
    "id": 1,
    "contract_unit_id": 101,
    "sales_reservation_id": 201,
    "final_selling_price": 1500000,
    "commission_percentage": 2.5,
    "total_amount": 37500,
    "vat": 5625,
    "marketing_expenses": 0,
    "bank_fees": 0,
    "net_amount": 31875,
    "commission_source": "owner",
    "status": "pending",
    "created_at": "2026-01-15T10:30:00Z"
  }
}
```

**ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู:**
```javascript
const createCommission = async (commissionData) => {
  try {
    const response = await axios.post('/api/sales/commissions', commissionData);
    
    console.log('ุชู ุฅูุดุงุก ุงูุนูููุฉ:', response.data.data);
    return response.data.data;
  } catch (error) {
    if (error.response?.data?.error_code === 'COMM_001') {
      alert('ุนูููุฉ ููุฌูุฏุฉ ุจุงููุนู ููุฐู ุงููุญุฏุฉ');
    } else if (error.response?.status === 422) {
      // ุฃุฎุทุงุก ุงูุชุญูู
      const errors = error.response.data.errors;
      displayValidationErrors(errors);
    }
    throw error;
  }
};

// ุงูุงุณุชุฎุฏุงู
const newCommission = await createCommission({
  contract_unit_id: 101,
  sales_reservation_id: 201,
  final_selling_price: 1500000,
  commission_percentage: 2.5,
  commission_source: 'owner'
});
```

---

### 3. ุชูุงุตูู ุนูููุฉ

**Endpoint:** `GET /api/sales/commissions/{id}`

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุฌูุจ ุชูุงุตูู ุงูุนูููุฉ ุจูุฌุงุญ",
  "data": {
    "id": 1,
    "contract_unit_id": 101,
    "sales_reservation_id": 201,
    "final_selling_price": 1500000,
    "commission_percentage": 2.5,
    "total_amount": 37500,
    "vat": 5625,
    "marketing_expenses": 2000,
    "bank_fees": 500,
    "net_amount": 29375,
    "commission_source": "owner",
    "status": "approved",
    "created_at": "2026-01-15T10:30:00Z",
    "updated_at": "2026-01-16T14:20:00Z",
    "contract_unit": {
      "id": 101,
      "unit_number": "A-101",
      "project_name": "ูุดุฑูุน ุงููุฎูู"
    },
    "sales_reservation": {
      "id": 201,
      "client_name": "ุฃุญูุฏ ูุญูุฏ",
      "client_mobile": "0501234567"
    },
    "distributions": [
      {
        "id": 1,
        "type": "lead_generation",
        "percentage": 30,
        "amount": 8812.5,
        "status": "approved",
        "user": {
          "id": 456,
          "name": "ุฎุงูุฏ ุนูู"
        }
      },
      {
        "id": 2,
        "type": "persuasion",
        "percentage": 25,
        "amount": 7343.75,
        "status": "approved",
        "user": {
          "id": 457,
          "name": "ุณุงุฑุฉ ุฃุญูุฏ"
        }
      }
    ]
  }
}
```

---

### 4. ุชุญุฏูุซ ูุตุงุฑูู ุงูุนูููุฉ

**Endpoint:** `PUT /api/sales/commissions/{id}/expenses`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ:** `commissions.update`

**Request Body:**
```json
{
  "marketing_expenses": 2000,
  "bank_fees": 500
}
```

**Validation:**
- ูุฌุจ ุฃู ุชููู ุงูุนูููุฉ ูู ุญุงูุฉ `pending`
- ุงููุตุงุฑูู ูุฌุจ ุฃูุง ุชุชุฌุงูุฒ ูุจูุบ ุงูุนูููุฉ ุงูุฅุฌูุงูู

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุชุญุฏูุซ ูุตุงุฑูู ุงูุนูููุฉ ุจูุฌุงุญ",
  "data": {
    "id": 1,
    "marketing_expenses": 2000,
    "bank_fees": 500,
    "net_amount": 29375
  }
}
```

---

### 5. ุชูุฒูุน ุงูุนูููุฉ

**Endpoint:** `POST /api/sales/commissions/{id}/distributions`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ:** `commissions.update`

**Request Body:**
```json
{
  "distributions": [
    {
      "user_id": 456,
      "type": "lead_generation",
      "percentage": 30,
      "bank_account": "SA1234567890",
      "notes": "ููุงุญุธุงุช ุงุฎุชูุงุฑูุฉ"
    },
    {
      "user_id": 457,
      "type": "persuasion",
      "percentage": 25
    },
    {
      "user_id": 458,
      "type": "closing",
      "percentage": 30
    },
    {
      "user_id": 459,
      "type": "management",
      "percentage": 15
    }
  ]
}
```

**Validation Rules:**
```javascript
{
  'distributions': 'required|array|min:1',
  'distributions.*.user_id': 'required_without:distributions.*.external_name',
  'distributions.*.external_name': 'required_without:distributions.*.user_id',
  'distributions.*.type': 'required|in:lead_generation,persuasion,closing,...',
  'distributions.*.percentage': 'required|numeric|min:0|max:100',
  'distributions.*.bank_account': 'nullable|string|max:50',
  // ูุฌููุน ุงููุณุจ ูุฌุจ ุฃู ูุณุงูู 100%
}
```

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุชูุฒูุน ุงูุนูููุฉ ุจูุฌุงุญ",
  "data": {
    "commission_id": 1,
    "distributions": [
      {
        "id": 1,
        "user_id": 456,
        "type": "lead_generation",
        "percentage": 30,
        "amount": 8812.5,
        "status": "pending"
      }
    ]
  }
}
```

**ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู:**
```javascript
const distributeCommission = async (commissionId, distributions) => {
  // ุงูุชุญูู ูู ุฃู ุงููุฌููุน = 100%
  const total = distributions.reduce((sum, d) => sum + d.percentage, 0);
  if (Math.abs(total - 100) > 0.01) {
    throw new Error('ูุฌููุน ุงููุณุจ ูุฌุจ ุฃู ูุณุงูู 100%');
  }
  
  try {
    const response = await axios.post(
      `/api/sales/commissions/${commissionId}/distributions`,
      { distributions }
    );
    return response.data.data;
  } catch (error) {
    if (error.response?.data?.error_code === 'COMM_003') {
      alert('ูุฌููุน ุงููุณุจ ูุง ูุณุงูู 100%');
    } else if (error.response?.data?.error_code === 'COMM_005') {
      alert('ูุง ูููู ุชูุฒูุน ุงูุนูููุฉ ุนูู ููุณ ุงูููุธู ุฃูุซุฑ ูู ูุฑุฉ');
    }
    throw error;
  }
};
```

---

### 6. ุงุนุชูุงุฏ ุชูุฒูุน

**Endpoint:** `POST /api/sales/commissions/distributions/{distributionId}/approve`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ:** `commission_distributions.approve`

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุงุนุชูุงุฏ ุงูุชูุฒูุน ุจูุฌุงุญ",
  "data": {
    "id": 1,
    "status": "approved",
    "approved_by": 789,
    "approved_at": "2026-01-16T10:00:00Z"
  }
}
```

---

### 7. ุฑูุถ ุชูุฒูุน

**Endpoint:** `POST /api/sales/commissions/distributions/{distributionId}/reject`

**Request Body:**
```json
{
  "reason": "ุณุจุจ ุงูุฑูุถ (ุงุฎุชูุงุฑู)"
}
```

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุฑูุถ ุงูุชูุฒูุน",
  "data": {
    "id": 1,
    "status": "rejected",
    "notes": "ุณุจุจ ุงูุฑูุถ"
  }
}
```

---

### 8. ุงุนุชูุงุฏ ุงูุนูููุฉ

**Endpoint:** `POST /api/sales/commissions/{id}/approve`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ:** `commissions.approve`

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุงุนุชูุงุฏ ุงูุนูููุฉ ุจูุฌุงุญ",
  "data": {
    "id": 1,
    "status": "approved"
  }
}
```

---

### 9. ุตุฑู ุงูุนูููุฉ

**Endpoint:** `POST /api/sales/commissions/{id}/mark-paid`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ:** `commissions.mark_paid`

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุตุฑู ุงูุนูููุฉ ุจูุฌุงุญ",
  "data": {
    "id": 1,
    "status": "paid"
  }
}
```

---

### 10. ููุฎุต ุงูุนูููุฉ

**Endpoint:** `GET /api/sales/commissions/{id}/summary`

**Response:**
```json
{
  "success": true,
  "data": {
    "commission": {
      "id": 1,
      "total_amount": 37500,
      "vat": 5625,
      "net_amount": 29375,
      "status": "approved"
    },
    "distributions_summary": {
      "total_distributions": 4,
      "pending_count": 0,
      "approved_count": 4,
      "rejected_count": 0,
      "total_distributed": 29375
    },
    "by_type": {
      "lead_generation": 8812.5,
      "persuasion": 7343.75,
      "closing": 8812.5,
      "management": 4406.25
    }
  }
}
```

---

## ููุงุท ุงูููุงูุฉ - ุงููุฏุงุฆุน

### 1. ูุงุฆูุฉ ุงููุฏุงุฆุน

**Endpoint:** `GET /api/sales/deposits`

**Parameters:**
```javascript
{
  status: 'pending',  // pending, received, refunded, confirmed
  from: '2026-01-01',
  to: '2026-12-31',
  per_page: 15,
  page: 1
}
```

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุฌูุจ ูุงุฆูุฉ ุงููุฏุงุฆุน ุจูุฌุงุญ",
  "data": [
    {
      "id": 1,
      "sales_reservation_id": 201,
      "contract_id": 301,
      "contract_unit_id": 101,
      "amount": 50000,
      "payment_method": "bank_transfer",
      "client_name": "ุฃุญูุฏ ูุญูุฏ",
      "payment_date": "2026-01-15",
      "commission_source": "owner",
      "status": "received",
      "created_at": "2026-01-15T09:00:00Z"
    }
  ],
  "meta": {
    "pagination": {
      "total": 50,
      "current_page": 1,
      "per_page": 15,
      "total_pages": 4
    }
  }
}
```

---

### 2. ุฅูุดุงุก ูุฏูุนุฉ ุฌุฏูุฏุฉ

**Endpoint:** `POST /api/sales/deposits`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ:** `deposits.create`

**Request Body:**
```json
{
  "sales_reservation_id": 201,
  "contract_id": 301,
  "contract_unit_id": 101,
  "amount": 50000,
  "payment_method": "bank_transfer",
  "client_name": "ุฃุญูุฏ ูุญูุฏ",
  "payment_date": "2026-01-15",
  "commission_source": "owner",
  "notes": "ููุงุญุธุงุช ุงุฎุชูุงุฑูุฉ"
}
```

**Validation Rules:**
```javascript
{
  sales_reservation_id: 'required|exists:sales_reservations,id',
  contract_id: 'required|exists:contracts,id',
  contract_unit_id: 'required|exists:contract_units,id',
  amount: 'required|numeric|min:1',
  payment_method: 'required|in:bank_transfer,cash,bank_financing',
  client_name: 'required|string|max:255',
  payment_date: 'required|date|before_or_equal:today',
  commission_source: 'required|in:owner,buyer',
  notes: 'nullable|string|max:1000'
}
```

**Response (201 Created):**
```json
{
  "success": true,
  "message": "ุชู ุฅูุดุงุก ุงููุฏูุนุฉ ุจูุฌุงุญ",
  "data": {
    "id": 1,
    "sales_reservation_id": 201,
    "amount": 50000,
    "payment_method": "bank_transfer",
    "status": "pending",
    "created_at": "2026-01-15T09:00:00Z"
  }
}
```

**ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู:**
```javascript
const createDeposit = async (depositData) => {
  try {
    const response = await axios.post('/api/sales/deposits', depositData);
    return response.data.data;
  } catch (error) {
    if (error.response?.data?.error_code === 'DEP_011') {
      alert('ุชุงุฑูุฎ ุงูุฏูุน ูุง ูููู ุฃู ูููู ูู ุงููุณุชูุจู');
    } else if (error.response?.data?.error_code === 'DEP_013') {
      alert('ุงููุญุฏุฉ ุงููุญุฏุฏุฉ ูุง ุชูุชูู ุฅูู ูุฐุง ุงููุดุฑูุน');
    }
    throw error;
  }
};
```

---

### 3. ุชูุงุตูู ูุฏูุนุฉ

**Endpoint:** `GET /api/sales/deposits/{id}`

**Response:**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "sales_reservation_id": 201,
    "contract_id": 301,
    "contract_unit_id": 101,
    "amount": 50000,
    "payment_method": "bank_transfer",
    "client_name": "ุฃุญูุฏ ูุญูุฏ",
    "payment_date": "2026-01-15",
    "commission_source": "owner",
    "status": "received",
    "confirmed_by": null,
    "confirmed_at": null,
    "notes": "ููุงุญุธุงุช",
    "created_at": "2026-01-15T09:00:00Z",
    "sales_reservation": {
      "id": 201,
      "reservation_type": "confirmed_reservation"
    },
    "contract": {
      "id": 301,
      "project_name": "ูุดุฑูุน ุงููุฎูู"
    },
    "contract_unit": {
      "id": 101,
      "unit_number": "A-101"
    }
  }
}
```

---

### 4. ุชุญุฏูุซ ูุฏูุนุฉ

**Endpoint:** `PUT /api/sales/deposits/{id}`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ:** `deposits.update`

**Request Body:**
```json
{
  "amount": 55000,
  "payment_method": "cash",
  "notes": "ุชุญุฏูุซ ุงูููุงุญุธุงุช"
}
```

**Validation:**
- ูููู ุชุญุฏูุซ ุงููุฏุงุฆุน ูู ุญุงูุฉ `pending` ุฃู `received` ููุท

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุชุญุฏูุซ ุงููุฏูุนุฉ ุจูุฌุงุญ",
  "data": {
    "id": 1,
    "amount": 55000,
    "payment_method": "cash"
  }
}
```

---

### 5. ุชุฃููุฏ ุงุณุชูุงู ุงููุฏูุนุฉ

**Endpoint:** `POST /api/sales/deposits/{id}/confirm-receipt`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ:** `deposits.confirm_receipt`

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุชุฃููุฏ ุงุณุชูุงู ุงููุฏูุนุฉ ุจูุฌุงุญ",
  "data": {
    "id": 1,
    "status": "confirmed",
    "confirmed_by": 789,
    "confirmed_at": "2026-01-16T10:00:00Z"
  }
}
```

---

### 6. ูุถุน ุนูุงูุฉ "ุชู ุงูุงุณุชูุงู"

**Endpoint:** `POST /api/sales/deposits/{id}/mark-received`

**Response:**
```json
{
  "success": true,
  "message": "ุชู ูุถุน ุนูุงูุฉ ุงุณุชูุงู ุงููุฏูุนุฉ",
  "data": {
    "id": 1,
    "status": "received"
  }
}
```

---

### 7. ุงุณุชุฑุฏุงุฏ ูุฏูุนุฉ

**Endpoint:** `POST /api/sales/deposits/{id}/refund`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ:** `deposits.refund`

**Request Body:**
```json
{
  "reason": "ุณุจุจ ุงูุงุณุชุฑุฏุงุฏ"
}
```

**Validation:**
- ูููู ุงุณุชุฑุฏุงุฏ ุงููุฏุงุฆุน ูู ูุตุฏุฑ `owner` ููุท
- ูุฌุจ ุฃู ุชููู ุงููุฏูุนุฉ ูู ุญุงูุฉ `received` ุฃู `confirmed`

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุงุณุชุฑุฏุงุฏ ุงููุฏูุนุฉ ุจูุฌุงุญ",
  "data": {
    "id": 1,
    "status": "refunded"
  }
}
```

**ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู:**
```javascript
const refundDeposit = async (depositId, reason) => {
  try {
    const response = await axios.post(
      `/api/sales/deposits/${depositId}/refund`,
      { reason }
    );
    return response.data.data;
  } catch (error) {
    const errorCode = error.response?.data?.error_code;
    
    if (errorCode === 'DEP_002') {
      alert('ูุง ูููู ุงุณุชุฑุฏุงุฏ ูุฏูุนุฉ ูู ูุตุฏุฑ ุงููุดุชุฑู');
    } else if (errorCode === 'DEP_003') {
      alert('ุชู ุงุณุชุฑุฏุงุฏ ุงููุฏูุนุฉ ุจุงููุนู');
    } else if (errorCode === 'DEP_010') {
      alert('ูุฌุจ ุชุฃููุฏ ุงููุฏูุนุฉ ุฃููุงู ูุจู ุงูุงุณุชุฑุฏุงุฏ');
    }
    throw error;
  }
};
```

---

### 8. ุงูุชุญูู ูู ุฅููุงููุฉ ุงูุงุณุชุฑุฏุงุฏ

**Endpoint:** `GET /api/sales/deposits/{id}/can-refund`

**Response:**
```json
{
  "success": true,
  "data": {
    "can_refund": true,
    "reason": "ุงููุฏูุนุฉ ูู ูุตุฏุฑ ุงููุงูู ููููู ุงุณุชุฑุฏุงุฏูุง"
  }
}
```

ุฃู:

```json
{
  "success": true,
  "data": {
    "can_refund": false,
    "reason": "ูุง ูููู ุงุณุชุฑุฏุงุฏ ูุฏูุนุฉ ูู ูุตุฏุฑ ุงููุดุชุฑู"
  }
}
```

---

### 9. ุญุฐู ูุฏูุนุฉ

**Endpoint:** `DELETE /api/sales/deposits/{id}`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ:** `deposits.delete`

**Validation:**
- ูููู ุญุฐู ุงููุฏุงุฆุน ูู ุญุงูุฉ `pending` ููุท

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุญุฐู ุงููุฏูุนุฉ ุจูุฌุงุญ"
}
```

---

### 10. ุชุฃููุฏ ูุฏุงุฆุน ูุชุนุฏุฏุฉ

**Endpoint:** `POST /api/sales/deposits/bulk-confirm`

**Request Body:**
```json
{
  "deposit_ids": [1, 2, 3, 4, 5]
}
```

**Response:**
```json
{
  "success": true,
  "message": "ุชู ุชุฃููุฏ 5 ูุฏุงุฆุน ุจูุฌุงุญ",
  "data": {
    "confirmed_count": 5,
    "failed_count": 0
  }
}
```

---

### 11. ูุฏุงุฆุน ุญุณุจ ุงูุญุฌุฒ

**Endpoint:** `GET /api/sales/deposits/by-reservation/{salesReservationId}`

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "amount": 50000,
      "status": "received",
      "payment_date": "2026-01-15"
    }
  ]
}
```

---

### 12. ุงููุฏุงุฆุน ุงููุงุจูุฉ ููุงุณุชุฑุฏุงุฏ

**Endpoint:** `GET /api/sales/deposits/refundable/project/{contractId}`

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "amount": 50000,
      "client_name": "ุฃุญูุฏ ูุญูุฏ",
      "payment_date": "2026-01-15",
      "commission_source": "owner",
      "status": "received"
    }
  ]
}
```

---

### 13. ูุงุฆูุฉ ุงููุชุงุจุนุฉ

**Endpoint:** `GET /api/sales/deposits/follow-up`

**ุงููุตู:** ุฌูุจ ุงููุฏุงุฆุน ุงูุชู ุชุญุชุงุฌ ูุชุงุจุนุฉ (pending)

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "amount": 50000,
      "client_name": "ุฃุญูุฏ ูุญูุฏ",
      "payment_date": "2026-01-15",
      "days_pending": 5,
      "status": "pending"
    }
  ]
}
```

---

## ุฃูุซูุฉ ุงูุชูุงูู

### ูุซุงู 1: ุฅูุดุงุก ุนูููุฉ ูุงููุฉ ูุน ุงูุชูุฒูุน

```javascript
// ุฏุงูุฉ ุดุงููุฉ ูุฅูุดุงุก ุนูููุฉ ูุน ุชูุฒูุนูุง
const createFullCommission = async (unitData, distributions) => {
  try {
    // 1. ุฅูุดุงุก ุงูุนูููุฉ
    const commission = await axios.post('/api/sales/commissions', {
      contract_unit_id: unitData.unitId,
      sales_reservation_id: unitData.reservationId,
      final_selling_price: unitData.price,
      commission_percentage: 2.5,
      commission_source: 'owner'
    });
    
    const commissionId = commission.data.data.id;
    console.log('ุชู ุฅูุดุงุก ุงูุนูููุฉ:', commissionId);
    
    // 2. ุฅุถุงูุฉ ุงููุตุงุฑูู (ุงุฎุชูุงุฑู)
    if (unitData.expenses) {
      await axios.put(`/api/sales/commissions/${commissionId}/expenses`, {
        marketing_expenses: unitData.expenses.marketing,
        bank_fees: unitData.expenses.bankFees
      });
      console.log('ุชู ุชุญุฏูุซ ุงููุตุงุฑูู');
    }
    
    // 3. ุชูุฒูุน ุงูุนูููุฉ
    await axios.post(`/api/sales/commissions/${commissionId}/distributions`, {
      distributions: distributions
    });
    console.log('ุชู ุชูุฒูุน ุงูุนูููุฉ');
    
    // 4. ุฌูุจ ุงูููุฎุต
    const summary = await axios.get(`/api/sales/commissions/${commissionId}/summary`);
    
    return {
      success: true,
      commission: commission.data.data,
      summary: summary.data.data
    };
    
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฅูุดุงุก ุงูุนูููุฉ:', error);
    throw error;
  }
};

// ุงูุงุณุชุฎุฏุงู
const result = await createFullCommission(
  {
    unitId: 101,
    reservationId: 201,
    price: 1500000,
    expenses: {
      marketing: 2000,
      bankFees: 500
    }
  },
  [
    { user_id: 456, type: 'lead_generation', percentage: 30 },
    { user_id: 457, type: 'persuasion', percentage: 25 },
    { user_id: 458, type: 'closing', percentage: 30 },
    { user_id: 459, type: 'management', percentage: 15 }
  ]
);
```

---

### ูุซุงู 2: ุฅุฏุงุฑุฉ ุฏูุฑุฉ ุญูุงุฉ ุงููุฏูุนุฉ

```javascript
// ุฏุงูุฉ ูุฅุฏุงุฑุฉ ุฏูุฑุฉ ุญูุงุฉ ุงููุฏูุนุฉ ุงููุงููุฉ
const manageDepositLifecycle = async (depositData) => {
  try {
    // 1. ุฅูุดุงุก ุงููุฏูุนุฉ
    const deposit = await axios.post('/api/sales/deposits', depositData);
    const depositId = deposit.data.data.id;
    console.log('ุชู ุฅูุดุงุก ุงููุฏูุนุฉ:', depositId);
    
    // 2. ูุถุน ุนูุงูุฉ "ุชู ุงูุงุณุชูุงู" (ุจุนุฏ ุงูุชุญูู ุงููุนูู)
    await axios.post(`/api/sales/deposits/${depositId}/mark-received`);
    console.log('ุชู ูุถุน ุนูุงูุฉ ุงูุงุณุชูุงู');
    
    // 3. ุชุฃููุฏ ุงูุงุณุชูุงู (ูู ูุจู ุงููุญุงุณุจ)
    await axios.post(`/api/sales/deposits/${depositId}/confirm-receipt`);
    console.log('ุชู ุชุฃููุฏ ุงูุงุณุชูุงู');
    
    // 4. ุงูุชุญูู ูู ุฅููุงููุฉ ุงูุงุณุชุฑุฏุงุฏ
    const refundCheck = await axios.get(`/api/sales/deposits/${depositId}/can-refund`);
    
    if (refundCheck.data.data.can_refund) {
      console.log('ูููู ุงุณุชุฑุฏุงุฏ ุงููุฏูุนุฉ');
      // ูููู ุนุฑุถ ุฒุฑ ุงูุงุณุชุฑุฏุงุฏ ูููุณุชุฎุฏู
    }
    
    return {
      success: true,
      deposit: deposit.data.data
    };
    
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฅุฏุงุฑุฉ ุงููุฏูุนุฉ:', error);
    throw error;
  }
};
```

---

### ูุซุงู 3: ููุญุฉ ุชุญูู ุชูุงุนููุฉ

```javascript
// ุฏุงูุฉ ูุฌูุจ ูุนุฑุถ ุจูุงูุงุช ููุญุฉ ุงูุชุญูู
const loadDashboard = async (filters = {}) => {
  try {
    // ุฌูุจ ุงููุคุดุฑุงุช ุงูุฑุฆูุณูุฉ
    const kpis = await axios.get('/api/sales/dashboard', { params: filters });
    
    // ุฌูุจ ุงููุญุฏุงุช ุงููุจุงุนุฉ
    const soldUnits = await axios.get('/api/sales/sold-units', { 
      params: { ...filters, per_page: 10 } 
    });
    
    // ุฌูุจ ุงูุชูุฑูุฑ ุงูุดูุฑู
    const monthlyReport = await axios.get('/api/sales/commissions/monthly-report', {
      params: {
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1
      }
    });
    
    return {
      kpis: kpis.data.data,
      soldUnits: soldUnits.data.data,
      monthlyReport: monthlyReport.data.data
    };
    
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุชุญููู ููุญุฉ ุงูุชุญูู:', error);
    throw error;
  }
};

// ุงูุงุณุชุฎุฏุงู ูุน React/Vue
useEffect(() => {
  loadDashboard({ date_from: '2026-01-01', date_to: '2026-01-31' })
    .then(data => {
      setKpis(data.kpis);
      setSoldUnits(data.soldUnits);
      setMonthlyReport(data.monthlyReport);
    });
}, []);
```

---

## ุฃูุถู ุงูููุงุฑุณุงุช

### 1. ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

```javascript
// ุฏุงูุฉ ูุฑูุฒูุฉ ููุนุงูุฌุฉ ุงูุฃุฎุทุงุก
const handleApiError = (error) => {
  if (!error.response) {
    // ุฎุทุฃ ูู ุงูุดุจูุฉ
    return {
      message: 'ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู',
      type: 'network'
    };
  }
  
  const { status, data } = error.response;
  
  switch (status) {
    case 401:
      // ุฅุนุงุฏุฉ ุชูุฌูู ูุชุณุฌูู ุงูุฏุฎูู
      window.location.href = '/login';
      return { message: 'ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู', type: 'auth' };
      
    case 403:
      return { message: 'ุตูุงุญูุงุช ุบูุฑ ูุงููุฉ', type: 'permission' };
      
    case 404:
      return { message: 'ุบูุฑ ููุฌูุฏ', type: 'notfound' };
      
    case 422:
      return { 
        message: 'ุฎุทุฃ ูู ุงูุจูุงูุงุช ุงููุฏุฎูุฉ', 
        type: 'validation',
        errors: data.errors 
      };
      
    case 409:
      return { 
        message: data.message, 
        type: 'conflict',
        code: data.error_code 
      };
      
    default:
      return { message: data.message || 'ุญุฏุซ ุฎุทุฃ', type: 'error' };
  }
};

// ุงูุงุณุชุฎุฏุงู
try {
  const result = await createCommission(data);
} catch (error) {
  const errorInfo = handleApiError(error);
  displayError(errorInfo);
}
```

---

### 2. ุงูุชุญูู ูู ุงูุจูุงูุงุช ูุจู ุงูุฅุฑุณุงู

```javascript
// ุฏุงูุฉ ููุชุญูู ูู ุชูุฒูุน ุงูุนูููุฉ
const validateDistributions = (distributions) => {
  const errors = [];
  
  // ุงูุชุญูู ูู ุงููุฌููุน = 100%
  const total = distributions.reduce((sum, d) => sum + d.percentage, 0);
  if (Math.abs(total - 100) > 0.01) {
    errors.push('ูุฌููุน ุงููุณุจ ูุฌุจ ุฃู ูุณุงูู 100%');
  }
  
  // ุงูุชุญูู ูู ุนุฏู ุงูุชูุฑุงุฑ
  const userIds = distributions
    .filter(d => d.user_id)
    .map(d => d.user_id);
  const uniqueIds = new Set(userIds);
  if (userIds.length !== uniqueIds.size) {
    errors.push('ูุง ูููู ุชูุฒูุน ุงูุนูููุฉ ุนูู ููุณ ุงูููุธู ุฃูุซุฑ ูู ูุฑุฉ');
  }
  
  // ุงูุชุญูู ูู ุงููุณูู ุงูุฎุงุฑุฌู
  distributions.forEach((d, index) => {
    if (d.type === 'external_marketer') {
      if (!d.external_name) {
        errors.push(`ุงูุชูุฒูุน ${index + 1}: ุงุณู ุงููุณูู ุงูุฎุงุฑุฌู ูุทููุจ`);
      }
      if (!d.bank_account) {
        errors.push(`ุงูุชูุฒูุน ${index + 1}: ุฑูู ุงูุญุณุงุจ ุงูุจููู ูุทููุจ`);
      }
    }
  });
  
  return {
    isValid: errors.length === 0,
    errors
  };
};

// ุงูุงุณุชุฎุฏุงู
const validation = validateDistributions(distributions);
if (!validation.isValid) {
  alert(validation.errors.join('\n'));
  return;
}
```

---

### 3. ุงุณุชุฎุฏุงู Interceptors

```javascript
// ุฅุนุฏุงุฏ Axios interceptors
axios.interceptors.request.use(
  config => {
    // ุฅุถุงูุฉ ุงูู token ุชููุงุฆูุงู
    const token = localStorage.getItem('auth_token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    
    // ุฅุถุงูุฉ timestamp
    config.headers['X-Request-Time'] = new Date().toISOString();
    
    return config;
  },
  error => Promise.reject(error)
);

axios.interceptors.response.use(
  response => response,
  error => {
    // ูุนุงูุฌุฉ ุงูุชูุงุก ุงูุฌูุณุฉ
    if (error.response?.status === 401) {
      localStorage.removeItem('auth_token');
      window.location.href = '/login';
    }
    
    return Promise.reject(error);
  }
);
```

---

### 4. ุงูุชุฎุฒูู ุงููุคูุช (Caching)

```javascript
// ุฏุงูุฉ ูุน ุชุฎุฒูู ูุคูุช
const cachedApiCall = (() => {
  const cache = new Map();
  const CACHE_DURATION = 5 * 60 * 1000; // 5 ุฏูุงุฆู
  
  return async (url, params = {}) => {
    const cacheKey = `${url}?${JSON.stringify(params)}`;
    const cached = cache.get(cacheKey);
    
    // ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุงุด
    if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
      console.log('ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุฎุฒูุฉ');
      return cached.data;
    }
    
    // ุฌูุจ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
    const response = await axios.get(url, { params });
    cache.set(cacheKey, {
      data: response.data,
      timestamp: Date.now()
    });
    
    return response.data;
  };
})();

// ุงูุงุณุชุฎุฏุงู
const kpis = await cachedApiCall('/api/sales/dashboard', { 
  date_from: '2026-01-01' 
});
```

---

### 5. ูุนุงูุฌุฉ Pagination

```javascript
// ุฏุงูุฉ ูุฌูุจ ุฌููุน ุงูุตูุญุงุช
const fetchAllPages = async (url, params = {}) => {
  let allData = [];
  let currentPage = 1;
  let hasMore = true;
  
  while (hasMore) {
    const response = await axios.get(url, {
      params: { ...params, page: currentPage, per_page: 50 }
    });
    
    allData = allData.concat(response.data.data);
    hasMore = response.data.meta.pagination.has_more_pages;
    currentPage++;
  }
  
  return allData;
};

// ุงูุงุณุชุฎุฏุงู
const allCommissions = await fetchAllPages('/api/sales/commissions', {
  status: 'approved'
});
console.log(`ุชู ุฌูุจ ${allCommissions.length} ุนูููุฉ`);
```

---

## ุญุงูุงุช ุงูุงุณุชุฎุฏุงู ุงูุดุงุฆุนุฉ

### ุญุงูุฉ 1: ุฅูุดุงุก ุนูููุฉ ุจุนุฏ ุจูุน ูุญุฏุฉ

```javascript
const handleUnitSold = async (unitData) => {
  try {
    // 1. ุฅูุดุงุก ุงูุนูููุฉ
    const commission = await axios.post('/api/sales/commissions', {
      contract_unit_id: unitData.id,
      sales_reservation_id: unitData.reservationId,
      final_selling_price: unitData.sellingPrice,
      commission_percentage: 2.5,
      commission_source: 'owner'
    });
    
    // 2. ุฅุถุงูุฉ ุงููุตุงุฑูู ุฅุฐุง ูุฌุฏุช
    if (unitData.marketingExpenses || unitData.bankFees) {
      await axios.put(
        `/api/sales/commissions/${commission.data.data.id}/expenses`,
        {
          marketing_expenses: unitData.marketingExpenses || 0,
          bank_fees: unitData.bankFees || 0
        }
      );
    }
    
    // 3. ุชูุฒูุน ุงูุนูููุฉ ุนูู ุงููุฑูู
    const distributions = calculateDistributions(unitData.salesTeam);
    await axios.post(
      `/api/sales/commissions/${commission.data.data.id}/distributions`,
      { distributions }
    );
    
    // 4. ุฅุดุนุงุฑ ุงููุณุชุฎุฏู
    showNotification('ุชู ุฅูุดุงุก ุงูุนูููุฉ ูุชูุฒูุนูุง ุจูุฌุงุญ', 'success');
    
    return commission.data.data;
    
  } catch (error) {
    const errorInfo = handleApiError(error);
    showNotification(errorInfo.message, 'error');
    throw error;
  }
};

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุญุณุงุจ ุงูุชูุฒูุนุงุช
const calculateDistributions = (salesTeam) => {
  return [
    {
      user_id: salesTeam.marketer,
      type: 'lead_generation',
      percentage: 30
    },
    {
      user_id: salesTeam.persuader,
      type: 'persuasion',
      percentage: 25
    },
    {
      user_id: salesTeam.closer,
      type: 'closing',
      percentage: 30
    },
    {
      user_id: salesTeam.manager,
      type: 'management',
      percentage: 15
    }
  ];
};
```

---

### ุญุงูุฉ 2: ุงุนุชูุงุฏ ุนูููุฉ ูุน ุฌููุน ุชูุฒูุนุงุชูุง

```javascript
const approveCommissionWithDistributions = async (commissionId) => {
  try {
    // 1. ุฌูุจ ุชูุงุตูู ุงูุนูููุฉ
    const commission = await axios.get(`/api/sales/commissions/${commissionId}`);
    const distributions = commission.data.data.distributions;
    
    // 2. ุงุนุชูุงุฏ ุฌููุน ุงูุชูุฒูุนุงุช
    for (const distribution of distributions) {
      if (distribution.status === 'pending') {
        await axios.post(
          `/api/sales/commissions/distributions/${distribution.id}/approve`
        );
      }
    }
    
    // 3. ุงุนุชูุงุฏ ุงูุนูููุฉ ููุณูุง
    await axios.post(`/api/sales/commissions/${commissionId}/approve`);
    
    showNotification('ุชู ุงุนุชูุงุฏ ุงูุนูููุฉ ูุฌููุน ุชูุฒูุนุงุชูุง', 'success');
    
  } catch (error) {
    showNotification('ุฎุทุฃ ูู ุงุนุชูุงุฏ ุงูุนูููุฉ', 'error');
    throw error;
  }
};
```

---

### ุญุงูุฉ 3: ุงุณุชุฑุฏุงุฏ ูุฏูุนุฉ ุจุนุฏ ุฅูุบุงุก ุญุฌุฒ

```javascript
const handleReservationCancellation = async (reservationId) => {
  try {
    // 1. ุฌูุจ ุงููุฏุงุฆุน ุงููุฑุชุจุทุฉ ุจุงูุญุฌุฒ
    const deposits = await axios.get(
      `/api/sales/deposits/by-reservation/${reservationId}`
    );
    
    // 2. ุงูุชุญูู ูู ุฅููุงููุฉ ุงูุงุณุชุฑุฏุงุฏ ููู ูุฏูุนุฉ
    for (const deposit of deposits.data.data) {
      const canRefund = await axios.get(
        `/api/sales/deposits/${deposit.id}/can-refund`
      );
      
      if (canRefund.data.data.can_refund) {
        // 3. ุงุณุชุฑุฏุงุฏ ุงููุฏูุนุฉ
        await axios.post(
          `/api/sales/deposits/${deposit.id}/refund`,
          { reason: 'ุฅูุบุงุก ุงูุญุฌุฒ' }
        );
        
        console.log(`ุชู ุงุณุชุฑุฏุงุฏ ุงููุฏูุนุฉ ${deposit.id}`);
      } else {
        console.log(`ูุง ูููู ุงุณุชุฑุฏุงุฏ ุงููุฏูุนุฉ ${deposit.id}: ${canRefund.data.data.reason}`);
      }
    }
    
    showNotification('ุชู ูุนุงูุฌุฉ ุงููุฏุงุฆุน', 'success');
    
  } catch (error) {
    showNotification('ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงููุฏุงุฆุน', 'error');
    throw error;
  }
};
```

---

### ุญุงูุฉ 4: ุชูุฑูุฑ ุดูุฑู ููููุธู

```javascript
const generateEmployeeMonthlyReport = async (employeeId, year, month) => {
  try {
    // 1. ุฌูุจ ุฅุญุตุงุฆูุงุช ุงูููุธู
    const stats = await axios.get(
      `/api/sales/commissions/stats/employee/${employeeId}`,
      {
        params: {
          date_from: `${year}-${month.toString().padStart(2, '0')}-01`,
          date_to: `${year}-${month.toString().padStart(2, '0')}-31`
        }
      }
    );
    
    // 2. ุฌูุจ ุงูุชูุฑูุฑ ุงูุดูุฑู ุงูุนุงู
    const monthlyReport = await axios.get(
      '/api/sales/commissions/monthly-report',
      { params: { year, month } }
    );
    
    // 3. ุชุฌููุน ุงูุจูุงูุงุช
    const report = {
      employee: stats.data.data,
      overall: monthlyReport.data.data,
      performance: calculatePerformance(stats.data.data, monthlyReport.data.data)
    };
    
    return report;
    
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฅูุดุงุก ุงูุชูุฑูุฑ:', error);
    throw error;
  }
};

const calculatePerformance = (employeeStats, overallStats) => {
  const employeeTotal = employeeStats.total_commissions;
  const overallTotal = overallStats.total_commissions;
  const percentage = (employeeTotal / overallTotal * 100).toFixed(2);
  
  return {
    percentage: percentage,
    rank: employeeStats.rank || 'N/A',
    comparison: `${percentage}% ูู ุฅุฌูุงูู ุงูุนูููุงุช`
  };
};
```

---

## ุงุณุชูุดุงู ุงูุฃุฎุทุงุก ูุฅุตูุงุญูุง

### ูุดููุฉ 1: ุฎุทุฃ 401 - Unauthorized

**ุงูุณุจุจ:** ุงูุชูุงุก ุตูุงุญูุฉ ุงูู token ุฃู ุนุฏู ุฅุฑุณุงูู

**ุงูุญู:**
```javascript
// ุงูุชุญูู ูู ูุฌูุฏ ุงูู token
const token = localStorage.getItem('auth_token');
if (!token) {
  window.location.href = '/login';
  return;
}

// ุฅุถุงูุฉ ุงูู token ููุทูุจุงุช
axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;

// ูุนุงูุฌุฉ ุงูุชูุงุก ุงูุตูุงุญูุฉ
axios.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401) {
      localStorage.removeItem('auth_token');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);
```

---

### ูุดููุฉ 2: ุฎุทุฃ 422 - Validation Error

**ุงูุณุจุจ:** ุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ

**ุงูุญู:**
```javascript
try {
  await axios.post('/api/sales/commissions', data);
} catch (error) {
  if (error.response?.status === 422) {
    const errors = error.response.data.errors;
    
    // ุนุฑุถ ุงูุฃุฎุทุงุก ูููุณุชุฎุฏู
    Object.keys(errors).forEach(field => {
      const errorMessages = errors[field];
      showFieldError(field, errorMessages.join(', '));
    });
  }
}

// ุฏุงูุฉ ูุนุฑุถ ุฎุทุฃ ุงูุญูู
const showFieldError = (fieldName, message) => {
  const fieldElement = document.querySelector(`[name="${fieldName}"]`);
  if (fieldElement) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    fieldElement.parentElement.appendChild(errorDiv);
  }
};
```

---

### ูุดููุฉ 3: ุฎุทุฃ COMM_003 - ูุฌููุน ุงูุชูุฒูุน ูุง ูุณุงูู 100%

**ุงูุณุจุจ:** ุฎุทุฃ ูู ุญุณุงุจ ุงููุณุจ

**ุงูุญู:**
```javascript
// ุฏุงูุฉ ูุถุจุท ุงููุณุจ ุชููุงุฆูุงู
const adjustPercentages = (distributions) => {
  const total = distributions.reduce((sum, d) => sum + d.percentage, 0);
  
  if (Math.abs(total - 100) < 0.01) {
    return distributions; // ุตุญูุญ ุจุงููุนู
  }
  
  // ุถุจุท ุงููุณุจุฉ ุงูุฃุฎูุฑุฉ
  const diff = 100 - total;
  distributions[distributions.length - 1].percentage += diff;
  
  return distributions;
};

// ุงูุงุณุชุฎุฏุงู
let distributions = [
  { type: 'lead_generation', percentage: 30 },
  { type: 'persuasion', percentage: 25 },
  { type: 'closing', percentage: 30 },
  { type: 'management', percentage: 14.99 } // ุฎุทุฃ ูู ุงูุญุณุงุจ
];

distributions = adjustPercentages(distributions);
// ุงูุขู management = 15.01 ูุงููุฌููุน = 100
```

---

### ูุดููุฉ 4: ุจุทุก ูู ุชุญููู ุงูุจูุงูุงุช

**ุงูุญู:**
```javascript
// ุงุณุชุฎุฏุงู ุงูุชุญููู ุงูุชุฏุฑูุฌู
const loadDataProgressively = async () => {
  // 1. ุชุญููู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ุฃููุงู
  const kpis = await axios.get('/api/sales/dashboard');
  updateUI({ kpis: kpis.data.data });
  
  // 2. ุชุญููู ุงูุจูุงูุงุช ุงูุซุงูููุฉ
  const soldUnits = await axios.get('/api/sales/sold-units', {
    params: { per_page: 10 }
  });
  updateUI({ soldUnits: soldUnits.data.data });
  
  // 3. ุชุญููู ุงูุจูุงูุงุช ุงูุชูุตูููุฉ ูู ุงูุฎูููุฉ
  setTimeout(async () => {
    const monthlyReport = await axios.get('/api/sales/commissions/monthly-report');
    updateUI({ monthlyReport: monthlyReport.data.data });
  }, 1000);
};
```

---

## ููุงุญุธุงุช ููุงุฆูุฉ

### ูุตุงุฆุญ ูููุฉ

1. **ุงุณุชุฎุฏู HTTPS ุฏุงุฆูุงู** ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ
2. **ูุง ุชุฎุฒู ุงูู token ูู localStorage** ุฅุฐุง ูุงู ุงููููุน ุนุฑุถุฉ ูู XSS
3. **ุงุณุชุฎุฏู debouncing** ููุทูุจุงุช ุงููุชูุฑุฑุฉ
4. **ุฃุถู loading states** ูุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู
5. **ุชุนุงูู ูุน ุงูุฃุฎุทุงุก ุจุดูู ูุงุถุญ** ูููุณุชุฎุฏู

### ุฑูุงุจุท ูููุฏุฉ

- [ูุฑุฌุน ุฑููุฒ ุงูุฃุฎุทุงุก](./ERROR_CODES_REFERENCE.md)
- [ุฏููู ูุธุงู ุงูุนูููุงุช](./COMMISSION_SYSTEM_GUIDE.md)
- [ุฏููู ูุธุงู ุงููุฏุงุฆุน](./DEPOSIT_SYSTEM_GUIDE.md)
- [ุฃูุซูุฉ ุงูุชูุงูู](./INTEGRATION_EXAMPLES.md)

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 1 ูุจุฑุงูุฑ 2026  
**ุงูุฅุตุฏุงุฑ:** 1.0  
**ุงูุฏุนู:** ูููุณุงุนุฏุฉุ ุชูุงุตู ูุน ูุฑูู ุงูุชุทููุฑ
