# دليل التكامل الشامل لواجهات برمجة التطبيقات (Frontend)

تاريخ التحديث: 1 فبراير 2026

هذا الدليل موجّه لفريق الواجهة الأمامية ويغطي جميع وحدات الـ API حسب `routes/api.php` و`API_PERMISSIONS_MAPPING.md`.

---

## 1) نظرة عامة سريعة

- جميع المسارات تبدأ بـ: `/api`
- المصادقة: Laravel Sanctum (Bearer Token)
- بعض الاستجابات تستخدم الشكل الموحد `{ success, message, data, meta }`، وبعضها يرجع `data` أو `message` فقط. لذلك يجب أن تتعامل الواجهة مع أكثر من شكل استجابة.

---

## 2) المصادقة والجلسات

### تسجيل الدخول
- `POST /api/login`
- يرجع توكن لاستخدامه في جميع الطلبات المحمية.

### ترويسات أساسية
- `Authorization: Bearer {token}`
- `Accept: application/json`

### نهاية الجلسة
- `POST /api/logout`

---

## 3) المتغيرات القياسية في Postman

الملف المحدث:
- `docs/POSTMAN_FRONTEND_COLLECTION.json`

أهم المتغيرات:
- `base_url`
- `token`
- `contract_id`, `contract_unit_id`, `reservation_id`
- `commission_id`, `deposit_id`, `distribution_id`
- `project_id`, `plan_id`, `lead_id`, `task_id`
- `user_id`, `exclusive_id`, `notification_id`
- `setting_key` (مثل: `conversion_rate`)

ملاحظة: بعض الطلبات داخل Postman هي placeholders بدون body تفصيلي. تفاصيل الحقول موضّحة أدناه.

---

## 4) الوحدات والمسارات الرئيسية

### أ) العقود (Contracts)
- قائمة العقود الخاصة بالمستخدم
- إنشاء عقد جديد
- عرض/تحديث/حذف عقد
- حفظ معلومات العقد (بعد الموافقة)

نقطة مهمة:
- حفظ معلومات العقد يتطلب أن تكون حالة العقد `approved` وسيقوم النظام بتحويل الحالة إلى `completed`.

---

### ب) إدارة المشاريع (Project Management)
- بيانات الطرف الثاني (عرض/حفظ/تحديث)
- جلب الأطراف الثانية حسب البريد
- وحدات العقد (عرض/إنشاء/تحديث/حذف + رفع CSV)
- أقسام المشروع: اللوحات، التصوير
- لوحة التحكم لإدارة المشاريع

---

### ج) المحرر (Editor)
- عرض العقود
- قسم المونتاج (عرض/حفظ/تحديث)

---

### د) المبيعات (Sales)
- لوحة التحكم (scope + from/to)
- المشاريع والوحدات
- الحجز (سياق، إنشاء، تأكيد، إلغاء، إجراءات، تحميل الفاتورة)
- الأهداف
- الحضور
- مهام التسويق (داخل المبيعات)
- قائمة الانتظار

ملاحظات مهمة:
- إلغاء الحجز يستخدم الحقل `cancellation_reason`.
- إنشاء الجدول (الحضور) يستخدم `schedule_date`, `start_time`, `end_time`.
- تحديث الهدف يعتمد على `status` فقط.

---

### هـ) التسويق (Marketing)
- لوحة التحكم
- المشاريع وحساب الميزانية
- الخطط (Developer / Employee)
- المبيعات المتوقعة
- المهام
- الفريق
- العملاء المحتملين (Leads)
- التقارير
- الإعدادات

---

### و) العمولات والودائع والتحليلات (Finance)
- تحليلات المبيعات
- العمولات (إنشاء، توزيع، اعتماد، صرف)
- توزيعات العمولات (تحديث، قبول، رفض)
- الودائع (إنشاء، تأكيد، استلام، استرداد، تقارير)

ملاحظات:
- بعض نقاط النهاية تُرجع ملفات (voucher/claim/export) وليست JSON.

---

### ز) المشاريع الحصرية (Exclusive Projects)
- طلب مشروع حصري
- الموافقة/الرفض
- إكمال العقد
- تصدير PDF

---

### ح) الإشعارات
- إشعارات المستخدم (private/public/mark read)
- إشعارات المدير (إرسال للمستخدم أو العامة)

---

### ط) الذكاء الاصطناعي (AI Assistant)
- `ask`, `chat`, `conversations`, `sections`
- يعتمد على الصلاحيات والسياق المرسل في الطلب

---

### ي) الملفات والبث اللحظي
- `GET /api/storage/{path}` لعرض الملفات
- `POST /api/broadcasting/auth` لتوثيق قنوات الـ WebSocket

---

## 5) سيناريوهات التكامل الأساسية (Workflow)

1. **العقود**: إنشاء عقد → موافقة الإدارة → حفظ معلومات العقد → إكمال الحالة.
2. **الطرف الثاني والوحدات**: حفظ بيانات الطرف الثاني → رفع CSV للوحدات → عرض الوحدات.
3. **المبيعات**: عرض المشاريع → سياق الحجز → إنشاء حجز → تأكيد → تحميل voucher.
4. **قائمة الانتظار**: إنشاء طلب → تحويل إلى حجز عند توفر الوحدة.
5. **التسويق**: حساب الميزانية → إنشاء خطة → تعيين فريق → مهام يومية → تقارير.
6. **العمولات**: إنشاء عمولة → توزيع → اعتماد → صرف.
7. **الودائع**: إنشاء وديعة → تأكيد الاستلام → استرداد/متابعة → تقارير.
8. **المشاريع الحصرية**: طلب → موافقة/رفض → إكمال عقد → تصدير.
9. **الإشعارات**: إرسال إشعار → جلبه في الواجهة → Mark as read.
10. **الذكاء الاصطناعي**: Ask → Chat → Conversations → Delete.

---

## 6) نقاط تكامل يجب الانتباه لها

- **اختلاف شكل الاستجابات**: لا تعتمد على وجود `success` دائماً.
- **طلبات الملفات**: بعض المسارات ترجع ملفات PDF/ملفات فعلية.
- **صلاحيات متعددة**: راجع `API_PERMISSIONS_MAPPING.md` لتحديد ما يظهر لكل دور.
- **التحقق من الحقول**: بعض الدوكمنت السابقة تحتوي على مسارات/حقول قديمة.

---

## 7) توصيات لفريق الواجهة الأمامية

- إضافة طبقة توحيد لمعالجة الأخطاء (401/403/422/500).
- استخدام pagination حيثما توفر.
- التعامل مع التحميل التدريجي للبيانات في الداشبورد والتقارير.
- حفظ الـ token بشكل آمن وإعادة تسجيل الدخول عند 401.

---

## 8) مراجع داخل المشروع

- `API_PERMISSIONS_MAPPING.md`
- `docs/POSTMAN_FRONTEND_COLLECTION.json`
- `docs/MISSING_SCENARIOS_REPORT_FULL.md`
- `docs/FRONTEND_WEBSOCKET_GUIDE.md`

---

**تم إعداد الدليل لفريق الواجهة الأمامية - الإصدار الشامل**
